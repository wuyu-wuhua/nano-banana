# 新用户积分赠送系统 - 安全机制说明

## 概述
本系统为新注册用户自动赠送50积分，采用简化的安全机制确保只有真正的新用户才能获得赠送。

## 安全机制

### 1. 简化条件检查
新用户必须**同时满足**以下所有条件才能获得赠送：

- ✅ **无积分记录**：用户从未有过积分记录
- ✅ **无交易记录**：用户从未有过任何积分交易（消费、充值、赠送等）
- ✅ **无时间限制**：移除注册时间限制，专注于用户行为记录

### 2. 数据库层面保护
- 使用 `SECURITY DEFINER` 确保函数以创建者权限运行
- 通过触发器自动处理，避免手动调用可能的安全风险
- 所有操作都在事务中执行，确保数据一致性

### 3. 防止滥用场景

#### 场景1：新用户正常注册 ✅
- 用户刚注册 → 获得50积分
- 这是预期行为

#### 场景2：老用户用完积分 ❌
- 用户有积分记录 → 不会获得赠送
- 用户有交易记录 → 不会获得赠送

#### 场景3：老用户删除积分记录 ❌
- 用户有交易记录 → 不会获得赠送
- 即使删除积分记录，交易记录仍然存在

#### 场景4：恶意重复注册 ❌
- 同一邮箱重复注册 → 每次都会检查所有条件
- 只有真正的新用户才能通过所有检查

## 数据库函数说明

### `nano_gift_new_user_credits(p_user_id UUID)`
- **功能**：检查并赠送新用户积分
- **返回值**：`true` 表示赠送成功，`false` 表示不符合条件
- **安全检查**：只检查积分和交易记录，无时间限制

### `nano_gift_google_oauth_user(p_user_id UUID)`
- **功能**：专门为Google OAuth用户检查并赠送积分
- **返回值**：`true` 表示赠送成功，`false` 表示不符合条件
- **安全检查**：与标准函数相同的逻辑，无时间限制

### `handle_new_user_registration()`
- **功能**：触发器函数，在新用户注册时自动调用
- **触发时机**：`auth.users` 表插入新记录后
- **自动执行**：无需手动调用，系统自动处理

## 日志记录
系统会记录所有相关操作：
- 用户调用welcome API的详细信息
- 积分赠送成功/失败的结果
- 用户ID和邮箱信息（用于调试）
- 详细的检查条件结果

## 使用建议

### 对于开发者
1. 确保在生产环境中运行数据库初始化脚本
2. 监控日志，确保系统正常运行
3. 定期检查积分赠送记录，验证系统安全性

### 对于用户
1. 新用户注册后会自动获得50积分
2. 老用户不会重复获得赠送
3. 积分使用完后需要充值，不会自动赠送

## 技术实现
- **数据库**：PostgreSQL + Supabase
- **触发器**：自动监听用户注册事件
- **API**：RESTful API端点处理积分赠送
- **前端**：React + Next.js 自动调用

## 安全总结
本系统通过简化的条件检查（无积分记录、无交易记录、无时间限制），确保只有真正的新注册用户才能获得积分赠送。这种设计既保证了安全性，又提高了用户体验，避免了因时间限制导致的误判。
